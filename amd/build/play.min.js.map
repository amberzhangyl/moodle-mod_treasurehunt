{"version":3,"sources":["../src/play.js"],"names":["define","$","url","ol","ajax","GeocoderJS","OSMGeocoder","viewgpx","str","playtreasurehunt","cmid","treasurehuntid","playwithoutmoving","groupmode","lastattempttimestamp","lastroadtimestamp","gameupdatetime","tracking","user","custommapconfig","terms","stringsqueried","map","term","key","component","get_strings","done","strings","i18n","i","length","custombackgroundurl","img","Image","addEventListener","imgwidth","naturalWidth","imgheight","naturalHeight","initplaytreasurehunt","src","custombaselayer","geographictools","defaultzoom","customimageextent","proj","transformExtent","bbox","geographic","bboxheight","centerwidth","centerheight","ratiorealmap","Math","round","adjwidth","adjheight","layer","title","layername","name","type","layertype","source","ImageStatic","imageExtent","opacity","wmsurl","options","TileWMS","params","wmsparams","customwmsextent","extent","Tile","hide","parchmenturl","imageUrl","failureurl","markerurl","lastsuccessfulstage","interval","infomsgs","attemptshistory","changesinattemptshistory","changesinquestionstage","fitmap","roadfinished","available","qoaremoved","osmGeocoderXHR","osmTimer","text","style","Text","textAlign","scale","fill","Fill","color","stroke","Stroke","width","selectText","defaultstageStyle","Style","image","Icon","anchor","zIndex","failstageStyle","defaultSelectstageStyle","failSelectstageStyle","positionFeatureStyle","Circle","radius","accuracyFeatureStyle","markerFeatureStyle","layers","geoJSONFormat","format","GeoJSON","Vector","projection","attemptslayer","feature","stageposition","get","styles","getText","setText","aeriallayer","visible","BingMaps","imagerySet","maxZoom","set","roadlayer","OSM","layersbase","layersoverlay","onlybase","push","layergroup","Group","toplayer","getLayers","forEach","setVisible","view","View","center","zoom","minZoom","select","interaction","Select","filter","accuracyFeature","Feature","setProperties","setStyle","positionFeature","userPosition","features","markerFeature","setGeometry","markerVector","concat","control","Zoom","target","className","Map","controls","loadTilesWhileAnimating","loadTilesWhileInteracting","addInteraction","renew_source","setInterval","item","class","getVisible","append","href","click","l","on","toggleClass","insertAfter","overlay","add_layer_to_list","tracklayergroup","addgpxlayer","tracklayer","htmltitle","plaintitle","substring","indexOf","validateposition","getGeometry","toast","autocentermap","position","geolocation","getPosition","fly_to","point","getView","fit","duration","animate","location","initialize","selectedanswerid","qrtext","currentposition","coordinates","answerid","writeGeometryObject","dataProjection","featureProjection","geojson","call","methodname","args","userprogress","attempttimestamp","roadtimestamp","response","status","qrexpected","show","historicalattempts","attempts","firststagegeom","clear","addFeatures","readFeatures","changesinlastsuccessfulstage","question","activitysolved","fit_map_to_source","set_question","set_attempts_history","infomsg","msg","clearInterval","css","fail","getFeatures","geom","Point","getCoordinates","getExtent","replace","html","counter","each","answers","answer","id","answertext","$historylist","appendTo","attempt","penalty","string","listview","trigger","Geolocation","getProjection","trackingOptions","enableHighAccuracy","maximumAge","timeout","validate_location","getAccuracyGeometry","trackinggeolocationwarndispatched","error","user_denied","message","code","PERMISSION_DENIED","setTimeout","popup","positionTo","setTracking","selected","panel","collapsible","stagename","stageclue","info","evt","hasFeature","forEachFeatureAtPixel","getEventPixel","originalEvent","getEventCoordinate","ev","abort","clearTimeout","$ul","value","search","resp","place","display_name","parseFloat","boundingbox","closeSidePanel","always","innerinfopanel","scrollTop","parseInt","offset","top","document","maxHeight","window","height","remove","updateSize","beforeclose","event","preventDefault","val","left","delay","fadeOut","removeClass"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module    mod_treasurehunt/play\n * @package   mod_treasurehunt\n * @copyright 2016 onwards Adrian Rodriguez Fernandez <huorwhisp@gmail.com>, Juan Pablo de Castro <jpdecastro@tel.uva.es>\n * @author Adrian Rodriguez <huorwhisp@gmail.com>\n * @author Juan Pablo de Castro <jpdecastro@tel.uva.es>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n  \"jquery\",\n  \"core/url\",\n  \"mod_treasurehunt/ol\",\n  \"core/ajax\",\n  \"mod_treasurehunt/geocoder\",\n  \"mod_treasurehunt/osm-geocoder\",\n  \"mod_treasurehunt/viewgpx\",\n  \"core/str\",\n  \"mod_treasurehunt/jquery.truncate\"\n  // \"mod_treasurehunt/jquery.mobile-config\",\n  // \"mod_treasurehunt/jquerymobile\"\n], function($, url, ol, ajax, GeocoderJS, OSMGeocoder, viewgpx, str) {\n  // console.log(\"loading play.js with jquery \" + $().jquery);\n  var init = {\n    playtreasurehunt: function(\n      cmid,\n      treasurehuntid,\n      playwithoutmoving,\n      groupmode,\n      lastattempttimestamp,\n      lastroadtimestamp,\n      gameupdatetime,\n      tracking,\n      user,\n      custommapconfig\n    ) {\n      // I18n strings.\n      var terms = [\n        \"stageovercome\",\n        \"failedlocation\",\n        \"stage\",\n        \"stagename\",\n        \"stageclue\",\n        \"question\",\n        \"noanswerselected\",\n        \"timeexceeded\",\n        \"searching\",\n        \"continue\",\n        \"noattempts\",\n        \"aerialview\",\n        \"roadview\",\n        \"noresults\",\n        \"startfromhere\",\n        \"nomarks\",\n        \"updates\",\n        \"activitytoendwarning\",\n        \"huntcompleted\",\n        \"discoveredlocation\",\n        \"answerwarning\",\n        \"error\"\n      ];\n      // console.log(\"loading i18n strings\");\n      var stringsqueried = terms.map(function(term) {\n        return { key: term, component: \"treasurehunt\" };\n      });\n      // i18n = i18nplay; // Use globally passed strings. Moodle 3.8 core/str broke with jquery 2.1.4.\n      str.get_strings(stringsqueried).done(function(strings) {\n        var i18n = [];\n        for (var i = 0; i < terms.length; i++) {\n          i18n[terms[i]] = strings[i]; // JPC: TODO: Global strings.\n        }\n        // i18n = i18nplay;\n        // Detect custom image.\n        if (\n          typeof custommapconfig != \"undefined\" &&\n          custommapconfig &&\n          custommapconfig.custombackgroundurl\n        ) {\n          // console.log(\"Detecting custom background image dimensions.\");\n          // Detect image size.\n          var img = new Image();\n          img.addEventListener(\"load\", function() {\n            custommapconfig.imgwidth = this.naturalWidth;\n            custommapconfig.imgheight = this.naturalHeight;\n            // console.log(\n            //   \"image is \" +\n            //     this.naturalWidth +\n            //     \"x\" +\n            //     this.naturalHeight +\n            //     \"pixels\"\n            // );\n            initplaytreasurehunt(\n              i18n,\n              cmid,\n              treasurehuntid,\n              playwithoutmoving,\n              groupmode,\n              lastattempttimestamp,\n              lastroadtimestamp,\n              gameupdatetime,\n              tracking,\n              user,\n              custommapconfig\n            );\n          });\n          img.src = custommapconfig.custombackgroundurl;\n        } else {\n          initplaytreasurehunt(\n            i18n,\n            cmid,\n            treasurehuntid,\n            playwithoutmoving,\n            groupmode,\n            lastattempttimestamp,\n            lastroadtimestamp,\n            gameupdatetime,\n            tracking,\n            user,\n            custommapconfig\n          );\n        }\n      });\n    } // End of function playtreasurehunt.\n  };\n  return init;\n  // Initialization function.\n  function initplaytreasurehunt(\n    strings,\n    cmid,\n    treasurehuntid,\n    playwithoutmoving,\n    groupmode,\n    lastattempttimestamp,\n    lastroadtimestamp,\n    gameupdatetime,\n    tracking,\n    user,\n    custommapconfig\n  ) {\n    // I18n support.\n    // console.log(\"init player Openlayers\");\n    // $.mobile.loading(\"show\");\n    var mapprojection = \"EPSG:3857\";\n    var custombaselayer = null;\n    var geographictools = true;\n    var defaultzoom = 19;\n    // Support customized base layers.\n    if (custommapconfig) {\n      if (custommapconfig.custombackgroundurl) {\n        // console.log(\"config custom background image\");\n        var customimageextent = ol.proj.transformExtent(\n          custommapconfig.bbox,\n          \"EPSG:4326\",\n          mapprojection\n        );\n        if (!custommapconfig.geographic) {\n          // Round bbox and scales to allow vectorial SVG rendering. (Maintain ratio.)\n          var bboxheight = customimageextent[3] - customimageextent[1];\n          var centerwidth = (customimageextent[2] + customimageextent[0]) / 2;\n          var centerheight = (customimageextent[3] + customimageextent[1]) / 2;\n\n          var ratiorealmap = Math.round(bboxheight / custommapconfig.imgheight);\n          var adjwidth = Math.round(custommapconfig.imgwidth * ratiorealmap);\n          var adjheight = Math.round(custommapconfig.imgheight * ratiorealmap);\n          customimageextent = [\n            centerwidth - adjwidth / 2,\n            centerheight - adjheight / 2,\n            centerwidth + adjwidth / 2,\n            centerheight + adjheight / 2\n          ];\n          defaultzoom = 5;\n        }\n        custombaselayer = new ol.layer.Image({\n          title: custommapconfig.layername,\n          name: custommapconfig.layername,\n          type: custommapconfig.layertype,\n          source: new ol.source.ImageStatic({\n            url: custommapconfig.custombackgroundurl,\n            imageExtent: customimageextent\n          }),\n          opacity: 1.0\n        });\n      } else if (custommapconfig.wmsurl) {\n        // console.log(\"config custom wms server: \" + custommapconfig.wmsurl);\n        var options = {\n          source: new ol.source.TileWMS({\n            url: custommapconfig.wmsurl,\n            params: custommapconfig.wmsparams\n          }),\n          type: custommapconfig.layertype,\n          title: custommapconfig.layername,\n          name: custommapconfig.layername\n        };\n        if (\n          custommapconfig.bbox[0] &&\n          custommapconfig.bbox[1] &&\n          custommapconfig.bbox[2] &&\n          custommapconfig.bbox[3]\n        ) {\n          var customwmsextent = ol.proj.transformExtent(\n            custommapconfig.bbox,\n            \"EPSG:4326\",\n            mapprojection\n          );\n          options.extent = customwmsextent;\n        }\n        custombaselayer = new ol.layer.Tile(options);\n      }\n\n      geographictools = custommapconfig.geographic;\n    }\n    if (geographictools === false) {\n      // console.log(\"geographic tools disabled\");\n      playwithoutmoving = true;\n      $(\"#autolocate\").hide();\n    }\n\n    let parchmenturl = url.imageUrl(\"success_mark\", \"treasurehunt\");\n    let failureurl = url.imageUrl(\"failure_mark\", \"treasurehunt\");\n    let markerurl = url.imageUrl(\"my_location\", \"treasurehunt\");\n    let lastsuccessfulstage = {};\n    let interval;\n    let infomsgs = [];\n    let attemptshistory = [];\n    let changesinattemptshistory = false;\n    // let changesinlastsuccessfulstage = false;\n    let changesinquestionstage = false;\n    let fitmap = false;\n    let roadfinished = false;\n    let available = true;\n    let qoaremoved = false;\n    let osmGeocoderXHR;\n    let osmTimer = 0;\n    /*-------------------------------Styles-----------------------------------*/\n    var text = new ol.style.Text({\n      textAlign: \"center\",\n      scale: 1.3,\n      fill: new ol.style.Fill({\n        color: \"#fff\"\n      }),\n      stroke: new ol.style.Stroke({\n        color: \"#000\",\n        width: 3.5\n      })\n    });\n    var selectText = new ol.style.Text({\n      textAlign: \"center\",\n      scale: 1.4,\n      fill: new ol.style.Fill({\n        color: \"#fff\"\n      }),\n      stroke: new ol.style.Stroke({\n        color: \"#3399CC\",\n        width: 3.5\n      })\n    });\n    var defaultstageStyle = new ol.style.Style({\n      image: new ol.style.Icon({\n        anchor: [0.5, 1],\n        opacity: 1,\n        scale: 0.5,\n        src: parchmenturl\n      }),\n      text: text,\n      zIndex: \"Infinity\"\n    });\n    var failstageStyle = new ol.style.Style({\n      image: new ol.style.Icon({\n        anchor: [0.5, 1],\n        opacity: 1,\n        scale: 0.5,\n        src: failureurl\n      }),\n      text: text,\n      zIndex: \"Infinity\"\n    });\n    var defaultSelectstageStyle = new ol.style.Style({\n      image: new ol.style.Icon({\n        anchor: [0.5, 1],\n        opacity: 1,\n        scale: 0.75,\n        src: parchmenturl\n      }),\n      text: selectText,\n      zIndex: \"Infinity\"\n    });\n    var failSelectstageStyle = new ol.style.Style({\n      image: new ol.style.Icon({\n        anchor: [0.5, 1],\n        opacity: 1,\n        scale: 0.75,\n        src: failureurl\n      }),\n      text: selectText,\n      zIndex: \"Infinity\"\n    });\n    var positionFeatureStyle = new ol.style.Style({\n      image: new ol.style.Circle({\n        radius: 6,\n        fill: new ol.style.Fill({\n          color: [0, 0, 0, 1]\n        }),\n        stroke: new ol.style.Stroke({\n          color: [255, 255, 255, 1],\n          width: 2\n        })\n      })\n    });\n    var accuracyFeatureStyle = new ol.style.Style({\n      fill: new ol.style.Fill({\n        color: [255, 255, 255, 0.3]\n      }),\n      stroke: new ol.style.Stroke({\n        color: [0, 0, 0, 0.5],\n        width: 1\n      }),\n      zIndex: -1\n    });\n    var markerFeatureStyle = new ol.style.Style({\n      image: new ol.style.Icon({\n        anchor: [0.5, 1],\n        opacity: 1,\n        scale: 0.35,\n        src: markerurl\n      })\n    });\n    /*-------------------------------Layers-----------------------------------*/\n    var layers = [];\n    var geoJSONFormat = new ol.format.GeoJSON();\n    var source = new ol.source.Vector({\n      projection: \"EPSG:3857\"\n    });\n    var attemptslayer = new ol.layer.Vector({\n      source: source,\n      style: style_function\n    });\n    var aeriallayer = new ol.layer.Tile({\n      visible: false,\n      source: new ol.source.BingMaps({\n        key: \"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR\",\n        imagerySet: \"AerialWithLabels\",\n        maxZoom: 19\n        // Use maxZoom 19 to see stretched tiles instead of the BingMaps\n        // \"no photos at this zoom level\" tiles\n        // maxZoom: 19.\n      })\n    });\n    aeriallayer.set(\"name\", strings[\"aerialview\"]);\n    var roadlayer = new ol.layer.Tile({\n      source: new ol.source.OSM()\n    });\n    roadlayer.set(\"name\", strings[\"roadview\"]);\n\n    var layersbase = [];\n    var layersoverlay = [];\n    if (!custommapconfig || custommapconfig.onlybase === false) {\n      layersbase = [aeriallayer, roadlayer];\n    }\n    if (custombaselayer) {\n      if (custommapconfig.layertype != \"overlay\") {\n        layersbase.push(custombaselayer);\n      } else {\n        layersoverlay.push(custombaselayer);\n      }\n    }\n    var layergroup = new ol.layer.Group({ layers: layersbase });\n    // All layers hidden except last one.\n    var toplayer = null;\n    layergroup.getLayers().forEach(function(layer) {\n      layer.setVisible(false);\n      toplayer = layer;\n    });\n    toplayer.setVisible(true);\n\n    var view = new ol.View({\n      center: [0, 0],\n      zoom: 2,\n      minZoom: 2\n    });\n    var select = new ol.interaction.Select({\n      layers: [attemptslayer],\n      style: select_style_function,\n      filter: function(feature) {\n        if (feature.get(\"stageposition\") === 0) {\n          return false;\n        }\n        return true;\n      }\n    });\n    var accuracyFeature = new ol.Feature();\n    accuracyFeature.setProperties({ name: \"user_accuracy\" });\n    accuracyFeature.setStyle(accuracyFeatureStyle);\n    var positionFeature = new ol.Feature();\n    positionFeature.setProperties({ name: \"user_position\" });\n    positionFeature.setStyle(positionFeatureStyle);\n    var userPosition = new ol.layer.Vector({\n      source: new ol.source.Vector({\n        features: [accuracyFeature, positionFeature]\n      })\n    });\n    var markerFeature = new ol.Feature();\n    markerFeature.setGeometry(null);\n    markerFeature.setStyle(markerFeatureStyle);\n    var markerVector = new ol.layer.Vector({\n      source: new ol.source.Vector({\n        features: [markerFeature]\n      })\n    });\n    layers.push(layergroup);\n    layers = layers.concat(layersoverlay);\n    layers = layers.concat([attemptslayer, userPosition, markerVector]);\n    // New Custom zoom.\n    var zoom = new ol.control.Zoom({\n      target: \"navigation\",\n      className: \"custom-zoom\"\n    });\n    var map = new ol.Map({\n      layers: layers,\n      controls: [zoom], //ol.control.defaults({rotate: false, attribution: false}),\n      target: \"mapplay\",\n      view: view,\n      loadTilesWhileAnimating: true,\n      loadTilesWhileInteracting: true\n    });\n    map.addInteraction(select);\n    // It initializes the game.\n    renew_source(false, true);\n    // For the game is updated every gameupdatetime seconds.\n    interval = setInterval(function() {\n      renew_source(false, false);\n    }, gameupdatetime);\n    // Initialize the page layers.\n\n    add_layergroup_to_list(layergroup);\n    layersoverlay.forEach(function(overlay) {\n      add_layer_to_list(overlay);\n    });\n    if (tracking && user) {\n      var tracklayergroup = viewgpx.addgpxlayer(\n        map,\n        cmid,\n        treasurehuntid,\n        strings,\n        user,\n        \"trackgroup\"\n      );\n      tracklayergroup.set(\"name\", tracklayergroup.get(\"title\"));\n\n      var tracklayer = tracklayergroup.getLayers().item(0);\n      var htmltitle = tracklayer.get(\"title\"); // Has a picture and a link.\n      var plaintitle = htmltitle.substring(htmltitle.indexOf(\"</a>\") + 4);\n      tracklayer.set(\"name\", plaintitle);\n      tracklayer.setVisible(false);\n      add_layer_to_list(tracklayer);\n    }\n    /*-------------------------------Functions-----------------------------------*/\n    function style_function(feature) {\n      // Get the income level from the feature properties.\n      var stageposition = feature.get(\"stageposition\");\n      if (stageposition === 0) {\n        var fill = new ol.style.Fill({\n          color: \"rgba(255,255,255,0.4)\"\n        });\n        var stroke = new ol.style.Stroke({\n          color: \"#3399CC\",\n          width: 1.25\n        });\n        var styles = new ol.style.Style({\n          image: new ol.style.Circle({\n            fill: fill,\n            stroke: stroke,\n            radius: 5\n          }),\n          fill: fill,\n          stroke: stroke,\n          text: new ol.style.Text({\n            text: strings[\"startfromhere\"],\n            textAlign: \"center\",\n            fill: new ol.style.Fill({\n              color: \"rgb(255,255,255)\"\n            }),\n            stroke: new ol.style.Stroke({\n              color: \"#3399CC\",\n              width: 5\n            })\n          })\n        });\n        return [styles];\n      }\n      if (!feature.get(\"geometrysolved\")) {\n        // Don't change the scale with the map. This is confusing failstageStyle.getImage().setScale((view.getZoom() / 30));.\n        failstageStyle.getText().setText(\"\" + stageposition);\n        return [failstageStyle];\n      }\n      // Don't change the scale with the map. This is confusing  defaultstageStyle.getImage().setScale((view.getZoom() / 100));.\n      defaultstageStyle.getText().setText(\"\" + stageposition);\n      return [defaultstageStyle];\n    }\n    function select_style_function(feature) {\n      var stageposition = feature.get(\"stageposition\");\n      if (!feature.get(\"geometrysolved\")) {\n        failSelectstageStyle.getText().setText(\"\" + stageposition);\n        return [failSelectstageStyle];\n      }\n      defaultSelectstageStyle.getText().setText(\"\" + stageposition);\n      return [defaultSelectstageStyle];\n    }\n    function validateposition() {\n      if (playwithoutmoving && !markerFeature.getGeometry()) {\n        toast(strings[\"nomarks\"]);\n      } else {\n        renew_source(true, false);\n      }\n    }\n    function autocentermap() {\n      const position = geolocation.getPosition();\n      fly_to(map, position);\n    }\n    function fly_to(map, point, extent) {\n      var duration = 700;\n      var view = map.getView();\n      if (extent) {\n        view.fit(extent, {\n          duration: duration\n        });\n      } else {\n        view.animate({\n          zoom: defaultzoom,\n          center: point,\n          duration: duration\n        });\n      }\n    }\n    /**\n     * Updates the model of the game.\n     * Notifies a new location for validation or a new answer to a question\n     * @param {boolean} location requests a location validation\n     * @param {boolean} initialize\n     * @param {int} selectedanswerid submits an answer to a question\n     * @param {string} qrtext submits a text scanned from a QRCode\n     * @returns {undefined}\n     */\n    function renew_source(location, initialize, selectedanswerid, qrtext) {\n      // var position holds the potition to be evaluated. undef if no evaluation requested\n      var position;\n      var currentposition;\n      var coordinates;\n      var answerid;\n\n      if (playwithoutmoving) {\n        coordinates = markerFeature.getGeometry();\n      } else {\n        coordinates = positionFeature.getGeometry();\n      }\n      if (coordinates) {\n        currentposition = geoJSONFormat.writeGeometryObject(coordinates, {\n          dataProjection: \"EPSG:4326\",\n          featureProjection: \"EPSG:3857\"\n        });\n      }\n      if (selectedanswerid) {\n        // $.mobile.loading(\"show\");\n        answerid = selectedanswerid;\n      }\n      if (location) {\n        position = currentposition;\n        // $.mobile.loading(\"show\");\n      }\n      var geojson = ajax.call([\n        {\n          methodname: \"mod_treasurehunt_user_progress\",\n          args: {\n            userprogress: {\n              treasurehuntid: treasurehuntid,\n              attempttimestamp: lastattempttimestamp,\n              roadtimestamp: lastroadtimestamp,\n              playwithoutmoving: playwithoutmoving,\n              groupmode: groupmode,\n              initialize: initialize,\n              location: position,\n              currentposition:\n                tracking && !playwithoutmoving ? currentposition : undefined, // only for tracking in mobility.\n              selectedanswerid: answerid,\n              qoaremoved: qoaremoved,\n              qrtext: qrtext\n            }\n          }\n        }\n      ]);\n      geojson[0]\n        .done(function(response) {\n          // let body = \"\";\n          qoaremoved = response.qoaremoved;\n          roadfinished = response.roadfinished;\n          available = response.available;\n          // $.mobile.loading(\"hide\");\n          // If I have sent a location or an answer I print out whether it is correct or not.\n          if (location || selectedanswerid) {\n            if (response.status && available) {\n              // console.log(response.status.msg);\n            }\n          }\n          if (response.qrexpected) {\n            $(\"#validateqr\").show();\n          } else {\n            $(\"#validateqr\").hide();\n          }\n          // If you change the game mode (mobile or static).\n          if (playwithoutmoving != response.playwithoutmoving) {\n            playwithoutmoving = response.playwithoutmoving;\n            if (!playwithoutmoving) {\n              markerFeature.setGeometry(null);\n            }\n          }\n          // If you change the group mode.\n          if (groupmode != response.groupmode) {\n            groupmode = response.groupmode;\n          }\n          if (\n            lastattempttimestamp !== response.attempttimestamp ||\n            lastroadtimestamp !== response.roadtimestamp ||\n            initialize ||\n            !available\n          ) {\n            lastattempttimestamp = response.attempttimestamp;\n            lastroadtimestamp = response.roadtimestamp;\n            if (response.historicalattempts.length > 0) {\n              attemptshistory = response.historicalattempts;\n              changesinattemptshistory = true;\n            }\n            // Compruebo si es distinto de null, lo que indica que se ha actualizado.\n            if (response.attempts || response.firststagegeom) {\n              source.clear();\n              if (response.firststagegeom) {\n                source.addFeatures(\n                  geoJSONFormat.readFeatures(response.firststagegeom, {\n                    dataProjection: \"EPSG:4326\",\n                    featureProjection: \"EPSG:3857\"\n                  })\n                );\n              }\n              if (response.attempts.features.length > 0) {\n                source.addFeatures(\n                  geoJSONFormat.readFeatures(response.attempts, {\n                    dataProjection: \"EPSG:4326\",\n                    featureProjection: \"EPSG:3857\"\n                  })\n                );\n              }\n            }\n            // Check if it exists, which indicates that it has been updated.\n            if (response.lastsuccessfulstage) {\n              lastsuccessfulstage = response.lastsuccessfulstage;\n              changesinlastsuccessfulstage = true;\n              // If the stage is not solved I will notify you that there are changes.\n              if (lastsuccessfulstage.question !== \"\") {\n                changesinquestionstage = true;\n                $(\"#validatelocation\").hide();\n                $(\"#question_button\").show();\n              } else if (!lastsuccessfulstage.activitysolved) {\n                $(\"#validatelocation\").hide();\n                $(\"#question_button\").show();\n              } else {\n                $(\"#validatelocation\").show();\n                $(\"#question_button\").hide();\n              }\n            }\n            // Check if it is the first geometry or it is being initialized and center the map.\n            if (response.firststagegeom || initialize) {\n              fitmap = true;\n            }\n            // Check the page we're on.\n            // var pageId = $.mobile.pageContainer\n            //   .pagecontainer(\"getActivePage\")\n            //   .prop(\"id\");\n            // // Update the page model wherever the page we are.\n            // set_lastsuccessfulstage();\n            fit_map_to_source();\n            set_question();\n            // if (pageId === \"mappage\") {\n            //   // Nothing special.\n            // } else if (pageId === \"historypage\") {\n            set_attempts_history();\n            // } else if (pageId === \"questionpage\") {\n            //   if (lastsuccessfulstage.question === \"\") {\n            //     $.mobile.pageContainer.pagecontainer(\"change\", \"#mappage\");\n            //   } else {\n            //     $.mobile.resetActivePageHeight();\n            //   }\n            // }\n          }\n          if (response.infomsg.length > 0) {\n            infomsgs.forEach(function() {\n              // body += \"<p>\" + msg + \"</p>\";\n            });\n            response.infomsg.forEach(function(msg) {\n              infomsgs.push(msg);\n              // body += \"<p>\" + msg + \"</p>\";\n            });\n            // create_popup(\"displayupdates\", strings[\"updates\"], body);\n          }\n          if (!roadfinished) {\n            $(\"#roadended\").hide();\n          }\n          if (roadfinished || !available) {\n            $(\"#validatelocation\").hide();\n            $(\"#question_button\").hide();\n            $(\"#roadended\").show();\n            markerFeature.setGeometry(null);\n            playwithoutmoving = false;\n            clearInterval(interval);\n            $(\"#mapplay\").css(\"opacity\", \"0.8\");\n          }\n        })\n        .fail(function() {\n          // console.log(error);\n          // create_popup(\"displayerror\", strings[\"error\"], error.message);\n          clearInterval(interval);\n        });\n    }\n    function fit_map_to_source() {\n      if (fitmap) {\n        var features = source.getFeatures();\n        if (\n          features.length === 1 &&\n          features[0].getGeometry() instanceof ol.geom.Point\n        ) {\n          fly_to(map, features[0].getGeometry().getCoordinates());\n        } else {\n          fly_to(map, null, source.getExtent());\n        }\n\n        fitmap = false;\n      }\n    }\n    // function set_lastsuccessfulstage() {\n    //   if (changesinlastsuccessfulstage) {\n    //     $(\"#lastsuccessfulstagename\").text(\n    //       strings[\"stage\"] + \":\" + lastsuccessfulstage.name\n    //     );\n    //     $(\"#lastsuccesfulstagepos\").text(\n    //       lastsuccessfulstage.position + \" / \" + lastsuccessfulstage.totalnumber\n    //     );\n    //     var maxchars = 100;\n    //     var briefing;\n    //     // Clean color styles from clue.\n    //     lastsuccessfulstage.clue = lastsuccessfulstage.clue.replace(\n    //       /color/gm,\n    //       \"color-disabled\"\n    //     );\n    //     $(\"#lastsuccessfulstageclue\").html(lastsuccessfulstage.clue);\n    //     var clueplaintext = lastsuccessfulstage.clue.replace(\n    //       /<(?:.|\\n)*?>/gm,\n    //       \"\"\n    //     );\n    //     if (clueplaintext.length > maxchars * 2) {\n    //       $(\"#lastsuccessfulstageclue\").truncate(maxchars * 2);\n    //       briefing =\n    //         ' <a href=\"#historypage\" data-transition=\"none\" class=\"ui-btn ui-shadow ui-corner-all ui-btn-icon-left ' +\n    //         'ui - btn - inline ui - icon - info ui - btn - icon - notext\"></a> ';\n    //       $(\"#lastsuccessfulstageclue\").append(briefing);\n    //     } else {\n    //       briefing = lastsuccessfulstage.clue;\n    //     }\n\n    //     $(\"#lastsuccessfulstagename2\").text(lastsuccessfulstage.name);\n    //     $(\"#lastsuccesfulstagepos2\").text(\n    //       lastsuccessfulstage.position + \" / \" + lastsuccessfulstage.totalnumber\n    //     );\n    //     $(\"#lastsuccessfulstageclue2\").html(lastsuccessfulstage.clue);\n\n    //     if (lastsuccessfulstage.question !== \"\") {\n    //       $(\"#lastsuccessfulstageclue\").append(\n    //         \"<a href='#questionpage' \" +\n    //           \"data-transition='none' class='ui-btn ui-shadow ui-corner-all \" +\n    //           \"ui-btn-icon-left ui-btn-inline ui-mini ui-icon-comment'>\" +\n    //           strings[\"question\"] +\n    //           \"</a>\"\n    //       );\n    //       $(\"#lastsuccessfulstageclue2\").append(\n    //         \"<a href='#questionpage' \" +\n    //           \"data-transition='none' class='ui-btn ui-shadow ui-corner-all \" +\n    //           \"ui-btn-icon-left ui-btn-inline ui-mini ui-icon-comment'>\" +\n    //           strings[\"question\"] +\n    //           \"</a>\"\n    //       );\n    //     }\n    //     $(\"#collapsibleset\").collapsibleset(\"refresh\");\n    //     $(\"#infopanel\").panel(\"open\");\n    //     $(\"#lastsuccessfulstage\").collapsible(\"expand\");\n    //     changesinlastsuccessfulstage = false;\n    //   }\n    // }\n    function set_question() {\n      if (changesinquestionstage) {\n        // Clean color tag.\n        lastsuccessfulstage.question = lastsuccessfulstage.question.replace(\n          /color/gm,\n          \"color-disabled\"\n        );\n\n        $(\"#questionform\").html(\n          \"<legend>\" + lastsuccessfulstage.question + \"</legend>\"\n        );\n        var counter = 1;\n        $.each(lastsuccessfulstage.answers, function(key, answer) {\n          var id = \"answer\" + counter;\n          // Clean color tag.\n          answer.answertext = answer.answertext.replace(\n            /color/gm,\n            \"color-disabled\"\n          );\n\n          $(\"#questionform\").append(\n            '<input type=\"radio\" name=\"answers\" id=\"' +\n              id +\n              '\"value=\"' +\n              answer.id +\n              '\">' +\n              '<label for=\"' +\n              id +\n              '\">' +\n              answer.answertext +\n              \"</label>\"\n          );\n          counter++;\n        });\n        // This decoration renders with problems.\n        // $('#questionform').enhanceWithin().controlgroup(\"refresh\");\n        changesinquestionstage = false;\n      }\n    }\n    function set_attempts_history() {\n      // Compruebo si ha habido cambios desde la ultima vez\n      if (changesinattemptshistory) {\n        var $historylist = $(\"#historylist\");\n        // Lo reinicio\n        $historylist.html(\"\");\n        changesinattemptshistory = false;\n        if (attemptshistory.length === 0) {\n          $(\"<li>\" + strings[\"noattempts\"] + \"</li>\").appendTo($historylist);\n        } else {\n          // Anado cada intento\n          attemptshistory.forEach(function(attempt) {\n            $(\n              \"<li><span class='ui-btn-icon-left \" +\n                (attempt.penalty\n                  ? \"ui-icon-delete failedattempt\"\n                  : \"ui-icon-check successfulattempt\") +\n                \"' style='position:relative'></span>\" +\n                attempt.string +\n                \"</li>\"\n            ).appendTo($historylist);\n          });\n        }\n        $historylist.listview(\"refresh\");\n        $historylist.trigger(\"updatelayout\");\n      }\n    }\n    function add_layer_to_list(layer) {\n      var item = $(\"<li>\", {\n        \"data-icon\": \"check\",\n        class: layer.getVisible() ? \"checked\" : \"unchecked\"\n      }).append(\n        $(\"<a />\", {\n          text: layer.get(\"name\"),\n          href: \"#mappage\"\n        }).click(function() {\n          layer.setVisible(!layer.getVisible());\n        })\n      );\n      layer.on(\"change:visible\", function() {\n        $(item).toggleClass(\"checked unchecked\");\n      });\n      item.insertAfter(\"#baseLayer\");\n    }\n\n    function add_layergroup_to_list(layergroup) {\n      layergroup.getLayers().forEach(layer => {\n        const item = $(\"<li>\", {\n          class: layer.getVisible()\n            ? \"checked close-modal\"\n            : \"unchecked close-modal\"\n        }).append(\n          $(\"<a />\", {\n            text: layer.get(\"name\"),\n            href: \"#mappage\"\n          }).click(() => {\n            layergroup.getLayers().forEach(l => {\n              if (l === layer) {\n                l.setVisible(true);\n              } else {\n                l.setVisible(false);\n              }\n            });\n          })\n        );\n        layer.on(\"change:visible\", () => {\n          $(item).toggleClass(\"checked unchecked\");\n        });\n        item.insertAfter(\"#baseLayer\");\n      });\n    }\n    /**\n     * Geolocation component\n     * @type ol.Geolocation\n     */\n    var geolocation = new ol.Geolocation(\n      /** @type {olx.GeolocationOptions} */ ({\n        projection: view.getProjection(),\n        trackingOptions: {\n          enableHighAccuracy: true,\n          maximumAge: 0,\n          timeout: 10000\n        }\n      })\n    );\n    /*-------------------------------Events-----------------------------------*/\n    geolocation.on(\"change:position\", function() {\n      var coordinates = this.getPosition();\n      positionFeature.setGeometry(\n        coordinates ? new ol.geom.Point(coordinates) : null\n      );\n      // The map must be re-centered in the new position\n      if (this.get(\"center\")) {\n        fly_to(map, coordinates);\n        this.setProperties({ center: false }); // Disable center request. Deprecated.\n      }\n      // the new position must be evaluated\n      if (this.get(\"validate_location\")) {\n        renew_source(true, false);\n        this.setProperties({ validate_location: false }); // Disable validate_location request. Deprecated.\n      }\n      // $.mobile.loading(\"hide\");\n    });\n    geolocation.on(\"change:accuracyGeometry\", function() {\n      accuracyFeature.setGeometry(this.getAccuracyGeometry());\n      // $.mobile.loading(\"hide\");\n    });\n    var trackinggeolocationwarndispatched = false;\n    geolocation.on(\"error\", function(error) {\n      // $.mobile.loading(\"hide\");\n      geolocation.setProperties({ user_denied: true });\n      toast(error.message);\n      if (\n        error.code == error.PERMISSION_DENIED &&\n        tracking &&\n        !playwithoutmoving &&\n        trackinggeolocationwarndispatched == false\n      ) {\n        setTimeout(function() {\n          $(\"#popupgeoloc\").popup(\"open\", { positionTo: \"window\" });\n          trackinggeolocationwarndispatched = true;\n        }, 500);\n      }\n    });\n    geolocation.setTracking(tracking); // Start position tracking.\n\n    select.on(\"select\", function(features) {\n      if (features.selected.length === 1) {\n        if (\n          lastsuccessfulstage.position ===\n            features.selected[0].get(\"stageposition\") &&\n          features.selected[0].get(\"geometrysolved\") &&\n          !roadfinished &&\n          available\n        ) {\n          $(\"#infopanel\").panel(\"open\");\n          $(\"#lastsuccessfulstage\").collapsible(\"expand\");\n        } else {\n          let stagename = features.selected[0].get(\"name\");\n          let stageclue = features.selected[0].get(\"clue\");\n          let info = features.selected[0].get(\"info\");\n          // let body = \"\";\n          // let title = \"\";\n          if (features.selected[0].get(\"geometrysolved\")) {\n            if (stagename && stageclue) {\n              // title = strings[\"stageovercome\"];\n              // body = get_block_text(strings[\"stagename\"], stagename);\n              // body += get_block_text(strings[\"stageclue\"], stageclue);\n            } else {\n              // title = strings[\"discoveredlocation\"];\n            }\n          } else {\n            // title = strings[\"failedlocation\"];\n          }\n          if (info) {\n            // body += \"<p>\" + info + \"</p>\";\n          }\n          // create_popup(\"infostage\", title, body);\n        }\n      }\n    });\n    map.on(\"click\", function(evt) {\n      var hasFeature = false;\n      map.forEachFeatureAtPixel(map.getEventPixel(evt.originalEvent), function(\n        feature\n      ) {\n        if (\n          feature.get(\"stageposition\") === 0 ||\n          feature.get(\"name\") === \"user_position\" ||\n          feature.get(\"name\") === \"user_accuracy\"\n        ) {\n          return false;\n        }\n        hasFeature = true;\n      });\n      if (playwithoutmoving && !hasFeature) {\n        var coordinates = map.getEventCoordinate(evt.originalEvent);\n        markerFeature.setGeometry(\n          coordinates ? new ol.geom.Point(coordinates) : null\n        );\n      }\n    });\n    $(\"#searchInput\").on(\"input\", ev => {\n      // Abort xhr request if a new one arrives\n      if (osmGeocoderXHR) {\n        osmGeocoderXHR.abort();\n      }\n      if (osmTimer) {\n        clearTimeout(osmTimer);\n      }\n      const $ul = $(\"#searchsResults\");\n      const value = ev.target.value;\n      let html = \"\";\n      $ul.html(html);\n      if (value && value.length > 2) {\n        // $.mobile.loading(\"show\", {\n        //   text: strings[\"searching\"],\n        //   textVisible: true,\n        //   theme: \"b\"\n        // });\n        osmTimer = setTimeout(() => {\n          osmGeocoderXHR = OSMGeocoder.search(value)\n            .done(resp => {\n              if (resp.length === 0) {\n                $ul.html(\"<li>\" + strings[\"noresults\"] + \"</li>\");\n              } else {\n                $.each(resp, (i, place) => {\n                  $(\"<li class='search-option'>\")\n                    .hide()\n                    .text(place.display_name)\n                    .appendTo($ul)\n                    .click(() => {\n                      var extent = [];\n                      extent[0] = parseFloat(place.boundingbox[2]);\n                      extent[1] = parseFloat(place.boundingbox[0]);\n                      extent[2] = parseFloat(place.boundingbox[3]);\n                      extent[3] = parseFloat(place.boundingbox[1]);\n                      extent = ol.proj.transformExtent(\n                        extent,\n                        \"EPSG:4326\",\n                        \"EPSG:3857\"\n                      );\n                      fly_to(map, null, extent);\n                      closeSidePanel(\"#searchpanel\");\n                    })\n                    .show();\n                });\n              }\n            })\n            .fail(() => {})\n            .always(() => {\n              osmGeocoderXHR = null;\n            });\n          //loading hide\n        }, 400);\n      }\n    });\n    // Scroll to collapsible expanded\n    $(\"#infopanel\").on(\n      \"collapsibleexpand\",\n      \"[data-role='collapsible']\",\n      function() {\n        var innerinfopanel = $(\"#infopanel .ui-panel-inner\");\n        innerinfopanel.animate(\n          {\n            scrollTop: parseInt(\n              $(this).offset().top -\n                innerinfopanel.offset().top +\n                innerinfopanel.scrollTop()\n            )\n          },\n          500\n        );\n      }\n    );\n    // Set a max-height to make large images shrink to fit the screen.\n    $(document).on(\"popupbeforeposition\", function() {\n      var maxHeight = $(window).height() - 200 + \"px\";\n      $('.ui-popup [data-role=\"content\"]').css(\"max-height\", maxHeight);\n    });\n    // Remove the popup after it has been closed to manage DOM size.\n    $(document).on(\n      \"popupafterclose\",\n      \".ui-popup:not(#QRdialog):not(#popupdialog):not(#popupgeoloc)\",\n      function() {\n        $(this).remove();\n        select.getFeatures().clear();\n      }\n    );\n\n    $(document).on(\"click\", \"#acceptupdates\", function() {\n      infomsgs = [];\n    });\n    // Redraw map.\n    $(window).on(\"resize\", function() {\n      map.updateSize();\n    });\n    //Buttons events.\n    if (geographictools) {\n      $(\"#autolocate\").on(\"click\", function() {\n        if (geolocation.get(\"user_denied\")) {\n          $(\"#popupgeoloc\").popup(\"open\", { positionTo: \"window\" });\n        } else {\n          autocentermap(true);\n        }\n      });\n    }\n    $(\"#infopanel\").panel({\n      beforeclose: function() {\n        select.getFeatures().clear();\n      }\n    });\n    $(\"#sendLocation\").on(\"click\", function() {\n      validateposition(true);\n    });\n    $(\"#sendAnswer\").on(\"click\", function(event) {\n      // Selecciono la respuesta.\n      var selected = $(\"#questionform input[type='radio']:checked\");\n      if (!available) {\n        event.preventDefault();\n        toast(strings[\"timeexceeded\"]);\n      } else {\n        if (selected.length === 0) {\n          event.preventDefault();\n          toast(strings[\"noanswerselected\"]);\n        } else {\n          renew_source(false, false, selected.val());\n        }\n      }\n    });\n    $(\"#validatelocation\").on(\"click\", function(event) {\n      if (roadfinished) {\n        event.preventDefault();\n        toast(strings[\"huntcompleted\"]);\n        return;\n      }\n      if (!available) {\n        event.preventDefault();\n        toast(strings[\"timeexceeded\"]);\n        return;\n      }\n      if (lastsuccessfulstage.question !== \"\") {\n        event.preventDefault();\n        toast(strings[\"answerwarning\"]);\n        $(\"#infopanel\").panel(\"open\");\n        return;\n      }\n      if (!lastsuccessfulstage.activitysolved) {\n        event.preventDefault();\n        toast(strings[\"activitytoendwarning\"]);\n        $(\"#infopanel\").panel(\"open\");\n        return;\n      }\n    });\n    /*-------------------------------Initialize page -------------*/\n\n    /*-------------------------------Help functions -------------*/\n    function toast(msg) {\n      if ($(\".toast\").length > 0) {\n        setTimeout(function() {\n          toast(msg);\n        }, 2500);\n      } else {\n        $(\n          \"<div class='ui-loader ui-overlay-shadow  ui-corner-all toast'>\" +\n            \"<p>\" +\n            msg +\n            \"</p></div>\"\n        )\n          .css({\n            left: ($(window).width() - 284) / 2,\n            top: $(window).height() / 2\n          })\n          .appendTo($(\"play-container\"))\n          .delay(2000)\n          .fadeOut(400, function() {\n            $(this).remove();\n          });\n      }\n    }\n    // function create_popup(type, title, body) {\n    //   var header = $('<div data-role=\"header\"><h2>' + title + \"</h2></div>\"),\n    //     content = $(\n    //       '<div data-role=\"content\" class=\"ui-content ui-overlay-b\">' +\n    //         body +\n    //         \"</div>\"\n    //     ),\n    //     popup = $(\n    //       '<div data-role=\"popup\" id=\"' +\n    //         type +\n    //         '\"' +\n    //         'data-theme=\"b\" data-transition=\"slidedown\"></div>'\n    //     );\n    //   if (type === \"infostage\") {\n    //     $(\n    //       '<a href=\"#\" data-rel=\"back\" class=\"ui-btn ui-corner-all' +\n    //         'ui-btn-b ui-icon-delete ui-btn-icon-notext ui-btn-right\"></a>'\n    //     ).appendTo(header);\n    //   }\n    //   if (type === \"displayupdates\") {\n    //     $(\n    //       '<p class=\"center-wrapper\"><a id=\"acceptupdates\" href=\"#\" data-rel=\"back\"' +\n    //         'class=\"ui-btn center-button ui-mini ui-btn-inline\">' +\n    //         strings[\"continue\"] +\n    //         \"</a></p>\"\n    //     ).appendTo(content);\n    //     var attributes = {\n    //       \"data-dismissible\": false,\n    //       \"data-overlay-theme\": \"b\"\n    //     };\n    //     $(popup).attr(attributes);\n    //   }\n    //   if (type === \"displayerror\") {\n    //     $(\n    //       '<p class=\"center-wrapper\"><a href=\"view.php?id=' +\n    //         cmid +\n    //         '\" class=\"ui-btn  center-button ui-mini ui-icon-forward ui-btn-inline ui-btn-icon-left\"' +\n    //         'data-ajax=\"false\">' +\n    //         strings[\"continue\"] +\n    //         \"</a></p>\"\n    //     ).appendTo(content);\n    //     var attributes = {\n    //       \"data-dismissible\": false,\n    //       \"data-overlay-theme\": \"b\"\n    //     };\n    //     $(popup).attr(attributes);\n    //   }\n    //   // Create the popup.\n    //   $(header)\n    //     .appendTo(\n    //       $(popup)\n    //         .appendTo($.mobile.activePage)\n    //         .popup()\n    //     )\n    //     .toolbar()\n    //     .after(content);\n    //   // Need it for calculate popup's dimesions when popup contents an image.\n    //   totalimg = $(content).find(\"img\");\n    //   if (totalimg.length > 0) {\n    //     // $.mobile.loading(\"show\");\n    //     totalimg.one(\"load\", function() {\n    //       imgloaded++;\n    //       if (totalimg.length === imgloaded) {\n    //         open_popup(popup);\n    //         imgloaded = 0;\n    //         // Clear the fallback\n    //         clearTimeout(fallback);\n    //         // $.mobile.loading(\"hide\");\n    //       }\n    //     });\n    //     // Fallback in case the browser doesn't fire a load event.\n    //     var fallback = setTimeout(function() {\n    //       open_popup(popup);\n    //       // $.mobile.loading(\"hide\");\n    //     }, 2000);\n    //   } else {\n    //     open_popup(popup);\n    //   }\n    // }\n    // function open_popup(popup) {\n    //   // Because chaining of popups not allowed in jquery mobile.\n    //   if ($(\".ui-popup-active\").length > 0) {\n    //     $(\".ui-popup\").popup(\"close\");\n    //     setTimeout(function() {\n    //       $(popup).popup(\"open\", { positionTo: \"window\" });\n    //     }, 1000);\n    //   } else {\n    //     $(popup).popup(\"open\", { positionTo: \"window\" });\n    //   }\n    // }\n    // function get_block_text(title, body) {\n    //   return (\n    //     '<div class=\"ui-bar ui-bar-a\">' +\n    //     title +\n    //     '</div><div class=\"ui-body ui-body-a\">' +\n    //     body +\n    //     \"</div>\"\n    //   );\n    // }\n\n    function closeSidePanel(id) {\n      $(id).removeClass(\"active\");\n      $(\".sidebar-mask\").removeClass(\"active dismissible\");\n    }\n  }\n});\n"],"file":"play.min.js"}